<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Поиск станков — токарные и фрезерные</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 1400px; margin: 0 auto; background: #f7f7f9; }
    h2 { margin: 0 0 .75em 0; }

    /* Вкладки */
    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .tab-btn {
      padding: 8px 14px; border: 1px solid #d1d5db; background:#fff; border-radius: 8px;
      cursor: pointer; font-weight: 600;
    }
    .tab-btn.active { background:#2563eb; color:#fff; border-color:#2563eb; }

    /* Макет */
    .container { display: grid; grid-template-columns: 350px 1fr; grid-template-areas: "form results"; gap: 20px; align-items: start; }
    #formCol     { grid-area: form; }
    #resultsCard { grid-area: results; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:12px; min-height:120px; overflow-x:auto; }

    /* Форма */
    #loading { color:#666; margin-bottom:10px; }
    .form-box { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:12px; display:grid; grid-template-columns:1fr; gap:.5em 0; }
    .form-box input[type="number"], .form-box select, .form-box button {
      width:100%; padding:.5em .6em; font-size:1em; box-sizing:border-box; border:1px solid #d1d5db; border-radius:6px; background:#fff;
    }
    .form-box button { background:#2563eb; color:#fff; border-color:#2563eb; cursor:pointer; }
    .form-box button:hover { background:#1d4ed8; border-color:#1d4ed8; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    input[type="number"] { -moz-appearance:textfield; }
    .checkbox-group { margin:.3em 0; }
    .checkbox-group label { display:flex; align-items:flex-start; gap:.4em; justify-self:start; font-size:.95em; }
    .checkbox-group input[type="checkbox"] { width:auto; margin-top:.15em; }

    /* Таблица результатов */
    #resultsTitle { margin:0 0 8px 0; font-size:1.05em; color:#374151; font-weight:600; }
    .table-wrap { width:100%; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { position:sticky; top:0; background:#f3f4f6; color:#374151; text-align:left; font-weight:600; border-bottom:1px solid #e5e7eb; padding:8px 10px; white-space:nowrap; }
    tbody td { border-bottom:1px solid #f1f5f9; padding:8px 10px; vertical-align:middle; white-space:nowrap; }
    tbody tr:hover { background: rgba(37,99,235,.15); }
    .td-name { font-weight:600; color:#111827; }
    .td-flag { text-align:center; width:80px; }
    .muted { color:#6b7280; }
    .empty { color:#6b7280; font-size:.95em; padding:.3em 0; }
    pre#error { white-space:pre-wrap; background:#fff5f5; border:1px solid #fbcfe8; padding:.6em; border-radius:6px; display:none; margin-top:10px; color:#9b1c1c; }
    pre#error-m { white-space:pre-wrap; background:#fff5f5; border:1px solid #fbcfe8; padding:.6em; border-radius:6px; display:none; margin-top:10px; color:#9b1c1c; }

    .hidden { display:none; }

    @media (max-width: 860px) { .container { grid-template-columns:1fr; grid-template-areas:"form" "results"; } thead th, tbody td { white-space:normal; } }
  </style>
</head>
<body>

  <h2>Поиск станков</h2>

  <!-- Вкладки -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="lathe">Токарные</button>
    <button class="tab-btn" data-tab="milling">Фрезерные</button>
  </div>

  <div class="container">
    <!-- Левая колонка: формы -->
    <div id="formCol">
      <div id="loading">Загрузка данных…</div>

      <!-- Форма: Токарные (как у тебя) -->
      <form id="form-lathe" class="form-box">
        <select id="L-C3"><option value="">— Все типы —</option></select>
        <input type="number" id="L-C4"  placeholder="Макс. диаметр точения" />
        <input type="number" id="L-C5"  placeholder="Макс. длина точения" />
        <input type="number" id="L-C6"  placeholder="Макс. скорость шпинделя" />
        <input type="number" id="L-C7"  placeholder="Диаметр патрона" />
        <div class="checkbox-group"><label><input type="checkbox" id="L-C8"  /> Ось Y</label></div>
        <div class="checkbox-group"><label><input type="checkbox" id="L-C9"  /> Противошпиндель</label></div>
        <div class="checkbox-group"><label><input type="checkbox" id="L-C10" /> Приводной инструмент</label></div>
        <button type="button" id="btn-search-lathe">Найти</button>
        <pre id="error"></pre>
      </form>

      <!-- Форма: Фрезерные -->
      <form id="form-milling" class="form-box hidden">
        <select id="M-C3"><option value="">— Все типы станков —</option></select>
        <input type="number" id="M-C4"  placeholder="Длина стола, мм (≥)" />
        <input type="number" id="M-C5"  placeholder="Ширина стола, мм (≥)" />
        <input type="number" id="M-C6"  placeholder="Скорость шпинделя, об/мин (≥)" />
        <input type="number" id="M-C7"  placeholder="Мощность шпинделя постоянная, кВт (≥)" />
        <input type="number" id="M-C8"  placeholder="Мощность шпинделя максимальная, кВт (≥)" />
        <input type="number" id="M-C9"  placeholder="Ход по оси X, мм (≥)" />
        <input type="number" id="M-C10" placeholder="Ход по оси Y, мм (≥)" />
        <input type="number" id="M-C11" placeholder="Ход по оси Z, мм (≥)" />
        <select id="M-C12"><option value="">— Любой конус шпинделя —</option></select>
        <div class="checkbox-group"><label><input type="checkbox" id="M-C13" /> Ось W</label></div>
        <button type="button" id="btn-search-milling">Найти</button>
        <pre id="error-m"></pre>
      </form>
    </div>

    <!-- Правая колонка: результаты -->
    <div id="resultsCard">
      <div id="resultsTitle">Результаты</div>
      <div id="results" class="table-wrap"></div>
    </div>
  </div>

<script>
/* ===== Конфиг таблиц ===== */
const SPREADSHEET_ID = "1uLMv39-f9U2qKzAanPEHXPRjNezLlZJC";
const TABS = {
  lathe:   { title: "Токарные",   gid: "1008569495" },
  milling: { title: "Фрезерные",  gid: "361418967" } // ← твой gid
};
const sheetCSV = ({sheetId, gid}) =>
  `/api/sheet?format=csv&sheetId=${encodeURIComponent(sheetId)}&gid=${encodeURIComponent(gid)}`;

/* ===== Состояние ===== */
const datasets = {
  lathe:   { dataStore: [], headerMap: {}, loaded: false },
  milling: { dataStore: [], headerMap: {}, loaded: false }
};
let activeTab = "lathe";

/* ===== Утилиты ===== */
const check = "✓", cross = "—";
const fmt = v => (v === -1 || v === "" || v == null ? "—" : v);
function toNumberStrict(v) {
  if (v == null) return null;
  const s = String(v).trim().replace(',', '.');
  if (!/^[+-]?\d+(\.\d+)?$/.test(s)) return null;
  return parseFloat(s);
}
function num(v){ const n = toNumberStrict(v); return n===null ? -1 : n; }
function boolStrict(v){
  if (v == null) return false;
  const n = toNumberStrict(v); if (n !== null) return n > 0;
  const s = String(v).trim().toLowerCase();
  return ["да","yes","true","есть","y","1"].includes(s);
}
const safeCell = (m,r,c) => (m[r] && m[r][c]!==undefined) ? m[r][c] : "";
function showErr(id, msg){ const b=document.getElementById(id); b.textContent=msg; b.style.display="block"; }

/* Надёжный CSV-парсер (кавычки и запятые внутри ячеек) */
function parseCSV(text) {
  const rows = [];
  let row = [], cur = '', inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], next = text[i+1];
    if (inQuotes) {
      if (ch === '"' && next === '"') { cur += '"'; i++; }
      else if (ch === '"') { inQuotes = false; }
      else { cur += ch; }
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { row.push(cur); cur = ''; }
      else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
      else if (ch === '\r') { /* skip */ }
      else { cur += ch; }
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows.filter(r => r.length && !(r.length===1 && r[0]===''));
}

/* ===== Преобразование данных ===== */
/* Токарные — как раньше */
function matrixToRecordsLathe(m){
  const res=[], map={};
  if(!m.length) return {res,map};
  const R = { v9:8, v10:9, v34:33, v35:34, f15:14, f17:16, toolSpeedRow:55 };
  const cols = m[0].length;
  for (let j=3;j<cols;j++){
    const h = String(safeCell(m,0,j)).toLowerCase().trim();
    if(!h) continue;
    let name = String(safeCell(m,2,j)).trim();
    if(!name || name.startsWith("#")) name = String(safeCell(m,0,j)).trim();
    const brand = String(safeCell(m,1,j)).trim();
    const item = {
      header:h, name, brand,
      v9:  num(safeCell(m,R.v9, j)),
      v10: num(safeCell(m,R.v10,j)),
      v34: num(safeCell(m,R.v34,j)),
      v35: num(safeCell(m,R.v35,j)),
      f15: boolStrict(safeCell(m,R.f15,j)),
      f17: boolStrict(safeCell(m,R.f17,j)),
      f56: (num(safeCell(m,R.toolSpeedRow,j))>0)
    };
    res.push(item);
    (map[h]=map[h]||[]).push(item);
  }
  return {res,map};
}

/* Фрезерные — по твоей карте строк */
function matrixToRecordsMilling(m){
  const res=[], map={};
  if(!m.length) return {res,map};
  const R = {
    type: 0,          // C3 = 1  -> индекс 0
    len: 7,           // C4 = 8  -> 7
    width: 8,         // C5 = 9  -> 8
    spindleSpeed: 42, // C6 = 43 -> 42
    powerConst: 43,   // C7 = 44 -> 43
    powerMax: 44,     // C8 = 45 -> 44
    axisX: 17,        // C9 = 18 -> 17
    axisY: 18,        // C10 = 19 -> 18
    axisZ: 19,        // C11 = 20 -> 19
    taper: 46,        // C12 = 47 -> 46
    axisW: 20         // C13 = 21 -> 20
  };
  const cols = m[0].length;
  for (let j=3;j<cols;j++){
    const h = String(safeCell(m,0,j)).toLowerCase().trim();
    if(!h) continue;
    let name = String(safeCell(m,2,j)).trim();
    if(!name || name.startsWith("#")) name = String(safeCell(m,0,j)).trim();
    const brand = String(safeCell(m,1,j)).trim();

    const item = {
      header: h, name, brand,
      type:  String(safeCell(m,R.type,j)).trim(),
      len:   num(safeCell(m,R.len,j)),
      width: num(safeCell(m,R.width,j)),
      spindleSpeed: num(safeCell(m,R.spindleSpeed,j)),
      powerConst:   num(safeCell(m,R.powerConst,j)),
      powerMax:     num(safeCell(m,R.powerMax,j)),
      axisX: num(safeCell(m,R.axisX,j)),
      axisY: num(safeCell(m,R.axisY,j)),
      axisZ: num(safeCell(m,R.axisZ,j)),
      taper: String(safeCell(m,R.taper,j)).trim(),
      axisW: num(safeCell(m,R.axisW,j))
    };
    res.push(item);
    (map[h]=map[h]||[]).push(item);
  }
  return {res,map};
}

/* Селекты: токарные = по заголовкам; фрезерные = по значениям type/taper */
function fillSelectLathe(headerMap){
  const sel=document.getElementById("L-C3");
  sel.innerHTML='<option value="">— Тип станка —</option>';
  Object.keys(headerMap).sort().forEach(key=>{
    const opt=document.createElement("option");
    opt.value=key; opt.textContent=key.charAt(0).toUpperCase()+key.slice(1);
    sel.appendChild(opt);
  });
}
function fillSelectMilling(dataStore){
  const typeSel=document.getElementById("M-C3");
  const taperSel=document.getElementById("M-C12");
  const types=new Set(), tapers=new Set();
  dataStore.forEach(it=>{ if(it.type) types.add(it.type); if(it.taper) tapers.add(it.taper); });
  typeSel.innerHTML='<option value="">— Тип станка —</option>' + [...types].sort().map(v=>`<option value="${v}">${v}</option>`).join('');
  taperSel.innerHTML='<option value="">— Конус шпинделя —</option>' + [...tapers].sort().map(v=>`<option value="${v}">${v}</option>`).join('');
}

/* Рендер таблиц */
function renderTableLathe(items){
  if(!items.length) return '<div class="empty">Ничего не найдено</div>';
  let html=`
  <table>
    <thead>
      <tr>
        <th>Производитель</th>
        <th>Модель</th>
        <th title="Макс. диаметр точения">Ø Точения</th>
        <th title="Макс. длина точения">Длина</th>
        <th title="Макс. скорость шпинделя">Скорость шпинделя</th>
        <th title="Диаметр патрона">Патрон</th>
        <th class="td-flag">Ось Y</th>
        <th class="td-flag">Противошп.</th>
        <th class="td-flag">Привод.инстр.</th>
      </tr>
    </thead>
    <tbody>`;
  for(const m of items){
    html += `
      <tr>
        <td><strong>${m.brand || "<span class='muted'>—</span>"}</strong></td>
        <td class="td-name">${m.name || "<span class='muted'>—</span>"}</td>
        <td>${fmt(m.v9)}</td>
        <td>${fmt(m.v10)}</td>
        <td>${fmt(m.v34)}</td>
        <td>${fmt(m.v35)}</td>
        <td class="td-flag">${m.f15 ? check : cross}</td>
        <td class="td-flag">${m.f17 ? check : cross}</td>
        <td class="td-flag">${m.f56 ? check : cross}</td>
      </tr>`;
  }
  html += `</tbody></table>`;
  return html;
}
function renderTableMilling(items){
  if(!items.length) return '<div class="empty">Ничего не найдено</div>';
  let html=`
  <table>
    <thead>
      <tr>
        <th>Производитель</th>
        <th>Модель</th>
        <th>Тип</th>
        <th>Длина стола</th>
        <th>Ширина стола</th>
        <th>Скорость шпинделя</th>
        <th>Мощн. пост.</th>
        <th>Мощн. макс.</th>
        <th>Ход X</th>
        <th>Ход Y</th>
        <th>Ход Z</th>
        <th>Конус</th>
        <th class="td-flag">Ось W</th>
      </tr>
    </thead>
    <tbody>`;
  for(const m of items){
    html += `
      <tr>
        <td><strong>${m.brand || "<span class='muted'>—</span>"}</strong></td>
        <td class="td-name">${m.name || "<span class='muted'>—</span>"}</td>
        <td>${fmt(m.type)}</td>
        <td>${fmt(m.len)}</td>
        <td>${fmt(m.width)}</td>
        <td>${fmt(m.spindleSpeed)}</td>
        <td>${fmt(m.powerConst)}</td>
        <td>${fmt(m.powerMax)}</td>
        <td>${fmt(m.axisX)}</td>
        <td>${fmt(m.axisY)}</td>
        <td>${fmt(m.axisZ)}</td>
        <td>${fmt(m.taper)}</td>
        <td>${fmt(m.axisW)}</td>
      </tr>`;
  }
  html += `</tbody></table>`;
  return html;
}

/* ===== Загрузка по вкладке ===== */
async function loadTabData(tabKey){
  const tab = TABS[tabKey];
  const state = datasets[tabKey];
  const loading = document.getElementById("loading");
  loading.style.display="block";
  try{
    if(!state.loaded){
      const r = await fetch(sheetCSV({sheetId:SPREADSHEET_ID, gid:tab.gid}) + `&_=${Date.now()}`);
      if(!r.ok) throw new Error(`CSV HTTP ${r.status}`);
      const matrix = parseCSV(await r.text());
      const parsed = (tabKey==="lathe") ? matrixToRecordsLathe(matrix) : matrixToRecordsMilling(matrix);
      state.dataStore = parsed.res;
      state.headerMap = parsed.map;
      state.loaded = true;
    }
    // заполнить селекты
    if(tabKey==="lathe") fillSelectLathe(state.headerMap);
    else fillSelectMilling(state.dataStore);

    // очистить результаты
    document.getElementById("results").innerHTML = '';
  }catch(e){
    const errId = (tabKey==="lathe") ? "error" : "error-m";
    showErr(errId, "Не удалось загрузить данные (CSV).\nПроверьте доступ к листу и gid.\n\n"+e.message);
  }finally{
    loading.style.display="none";
  }
}

/* ===== Поиск по вкладкам ===== */
function doSearchLathe(){
  const { dataStore, headerMap } = datasets.lathe;
  if(!dataStore.length){ alert("Данные ещё загружаются…"); return; }

  const C3  = document.getElementById("L-C3").value;
  const C4  = +document.getElementById("L-C4").value || 0;
  const C5  = +document.getElementById("L-C5").value || 0;
  const C6  = +document.getElementById("L-C6").value || 0;
  const C7  = +document.getElementById("L-C7").value || 0;
  const C8  = document.getElementById("L-C8").checked;
  const C9  = document.getElementById("L-C9").checked;
  const C10 = document.getElementById("L-C10").checked;

  const cand = (C3 && headerMap[C3]) ? headerMap[C3] : dataStore;
  const matches=[];
  for(const item of cand){
    if(!item.name) continue;
    if (C4 && item.v9  !== -1 && (C4 > item.v9  || (C4 + 100) < item.v9)) continue;
    if (C5 && item.v10 !== -1 && (C5 > item.v10 || (C5 + C5*1.5) < item.v10)) continue;
    if (C6 && item.v34 !== -1 &&  C6 > item.v34) continue;
    if (C7 && item.v35 !== -1 &&  C7 > item.v35) continue;
    if (C8  && !item.f15) continue;
    if (C9  && !item.f17) continue;
    if (C10 && !item.f56) continue;
    matches.push(item);
  }
  document.getElementById("results").innerHTML = renderTableLathe(matches);
}

function doSearchMilling(){
  const { dataStore } = datasets.milling;
  if(!dataStore.length){ alert("Данные ещё загружаются…"); return; }

  // фильтры
  const F = {
    type:  document.getElementById("M-C3").value.trim(),
    len:   +document.getElementById("M-C4").value  || 0,
    width: +document.getElementById("M-C5").value  || 0,
    spin:  +document.getElementById("M-C6").value  || 0,
    pConst:+document.getElementById("M-C7").value  || 0,
    pMax:  +document.getElementById("M-C8").value  || 0,
    x:     +document.getElementById("M-C9").value  || 0,
    y:     +document.getElementById("M-C10").value || 0,
    z:     +document.getElementById("M-C11").value || 0,
    taper: document.getElementById("M-C12").value.trim(),
    w:     document.getElementById("M-C13").checked
  };

  const matches=[];
  for(const it of dataStore){
    if(!it.name) continue;

    if (F.type  && String(it.type).trim()  !== F.type)  continue;
    if (F.taper && String(it.taper).trim() !== F.taper) continue;

    // числовые: считаем, что пользователь указывает минимально требуемое значение
    if (F.len   && it.len          !== -1 && it.len          < F.len)   continue;
    if (F.width && it.width        !== -1 && it.width        < F.width) continue;
    if (F.spin  && it.spindleSpeed !== -1 && it.spindleSpeed < F.spin)  continue;
    if (F.pConst&& it.powerConst   !== -1 && it.powerConst   < F.pConst)continue;
    if (F.pMax  && it.powerMax     !== -1 && it.powerMax     < F.pMax)  continue;
    if (F.x     && it.axisX        !== -1 && it.axisX        < F.x)     continue;
    if (F.y     && it.axisY        !== -1 && it.axisY        < F.y)     continue;
    if (F.z     && it.axisZ        !== -1 && it.axisZ        < F.z)     continue;

    if (F.w && !(it.axisW > 0)) continue;

    matches.push(it);
  }
  document.getElementById("results").innerHTML = renderTableMilling(matches);
}

/* ===== Инициализация и переключение вкладок ===== */
window.addEventListener("DOMContentLoaded", async () => {
  // Переключение вкладок + показ нужной формы
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", async () => {
      if(btn.dataset.tab === activeTab) return;
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      activeTab = btn.dataset.tab;

      document.getElementById("form-lathe").classList.toggle("hidden", activeTab!=="lathe");
      document.getElementById("form-milling").classList.toggle("hidden", activeTab!=="milling");

      await loadTabData(activeTab);
    });
  });

  document.getElementById("btn-search-lathe").addEventListener("click", doSearchLathe);
  document.getElementById("btn-search-milling").addEventListener("click", doSearchMilling);

  // стартуем с токарных
  await loadTabData(activeTab);
});
</script>
</body>
</html>
