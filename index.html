<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>Поиск станков — токарные и фрезерные</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
      background: #f7f7f9;
    }

    h2 {
      margin: 0 0 .75em 0;
    }

    /* Вкладки */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tab-btn {
      padding: 8px 14px;
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .tab-btn.active {
      background: #ec691f;
      color: #fff;
      border-color: #ec691f;
    }

    /* Макет */
    .container {
      display: grid;
      grid-template-columns: 350px 1fr;
      grid-template-areas: "form results";
      gap: 20px;
      align-items: start;
    }

    #formCol {
      grid-area: form;
    }

    #resultsCard {
      grid-area: results;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      min-height: 120px;
      overflow-x: auto;
    }

    /* Формы */
    #loading {
      color: #666;
      margin-bottom: 10px;
    }

    .form-box {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: .5em 0;
    }

    .form-box input[type="number"],
    .form-box select,
    .form-box button {
      width: 100%;
      padding: .5em .6em;
      font-size: 1em;
      box-sizing: border-box;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
    }

    .form-box button {
      background: #ec691f;
      color: #fff;
      border-color: #ec691f;
      cursor: pointer;
    }

    .form-box button:hover {
      background: #ec691f;
      border-color: #ec691f;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .checkbox-group {
      margin: .3em 0;
    }

    .checkbox-group label {
      display: flex;
      align-items: flex-start;
      gap: .4em;
      justify-self: start;
      font-size: .95em;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-top: .15em;
    }

    /* Таблица результатов */
    #resultsTitle {
      margin: 0 0 8px 0;
      font-size: 1.05em;
      color: #374151;
      font-weight: 600;
    }

    .table-wrap {
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      color: #374151;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      white-space: nowrap;
    }

    tbody td {
      border-bottom: 1px solid #f1f5f9;
      padding: 8px 10px;
      vertical-align: middle;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, .15);
    }

    .td-name {
      font-weight: 600;
      color: #111827;
    }

    .td-flag {
      text-align: center;
      width: 80px;
    }

    .muted {
      color: #6b7280;
    }

    .empty {
      color: #6b7280;
      font-size: .95em;
      padding: .3em 0;
    }

    .res-row {
      cursor: pointer;
    }

    /* Ошибки */
    pre#error,
    pre#error-m {
      white-space: pre-wrap;
      background: #fff5f5;
      border: 1px solid #fbcfe8;
      padding: .6em;
      border-radius: 6px;
      display: none;
      margin-top: 10px;
      color: #9b1c1c;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 860px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-areas: "form" "results";
      }

      thead th,
      tbody td {
        white-space: normal;
      }
    }
  </style>
</head>

<body>
  <h2>Поиск станков</h2>

  <div class="tabs">
    <button class="tab-btn active" data-tab="lathe">Токарные</button>
    <button class="tab-btn" data-tab="milling">Фрезерные</button>
  </div>

  <div class="container">
    <div id="formCol">
      <div id="loading">Загрузка данных…</div>

      <!-- Форма: Токарные -->
      <form id="form-lathe" class="form-box">
        <select id="L-C3">
          <option value="">— Все типы —</option>
        </select>
        <input type="number" id="L-C4" placeholder="Макс. диаметр точения, мм" />
        <input type="number" id="L-C5" placeholder="Макс. длина точения, мм" />
        <input type="number" id="L-C6" placeholder="Макс. скорость шпинделя, об/мин" />
        <input type="number" id="L-C7" placeholder="Диаметр патрона, дюйм" />
        <div class="checkbox-group"><label><input type="checkbox" id="L-C8" /> Ось Y</label></div>
        <div class="checkbox-group"><label><input type="checkbox" id="L-C9" /> Противошпиндель</label></div>
        <div class="checkbox-group"><label><input type="checkbox" id="L-C10" /> Приводной инструмент</label></div>
        <button type="button" id="btn-search-lathe">Найти</button>
        <pre id="error"></pre>
      </form>

      <!-- Форма: Фрезерные -->
      <form id="form-milling" class="form-box hidden">
        <select id="M-C3">
          <option value="">— Все типы станков —</option>
        </select>
        <input type="number" id="M-C4" placeholder="Длина стола, мм (≥)" />
        <input type="number" id="M-C5" placeholder="Ширина стола, мм (≥)" />
        <input type="number" id="M-C6" placeholder="Скорость шпинделя, об/мин (≥)" />
        <input type="number" id="M-C7" placeholder="Мощность шпинделя постоянная, кВт (≥)" />
        <input type="number" id="M-C8" placeholder="Мощность шпинделя максимальная, кВт (≥)" />
        <input type="number" id="M-C9" placeholder="Ход по оси X, мм (≥)" />
        <input type="number" id="M-C10" placeholder="Ход по оси Y, мм (≥)" />
        <input type="number" id="M-C11" placeholder="Ход по оси Z, мм (≥)" />
        <select id="M-C12">
          <option value="">— Любой конус шпинделя —</option>
        </select>
        <div class="checkbox-group"><label><input type="checkbox" id="M-C13" /> Ось W</label></div>
        <button type="button" id="btn-search-milling">Найти</button>
        <pre id="error-m"></pre>
      </form>
    </div>

    <div id="resultsCard">
      <div id="resultsTitle">Результаты</div>
      <div id="results" class="table-wrap"></div>
    </div>
  </div>

  <script>
    'use strict';

    /* ===== Конфиг листов ===== */
    const SPREADSHEET_ID = '1uLMv39-f9U2qKzAanPEHXPRjNezLlZJC';
    const TABS = {
      lathe: { gid: '1008569495' },
      milling: { gid: '361418967' }
    };
    const sheetCSV = ({ sheetId, gid }) => (
      `/api/sheet?format=csv&sheetId=${encodeURIComponent(sheetId)}&gid=${encodeURIComponent(gid)}`
    );
    
    // ==== предупреждение при показе устаревших данных ====
    function showStaleNotice(msg = "Показаны данные из кэша — сеть недоступна.") {
      const id = "staleNotice";
      let el = document.getElementById(id);
      if (!el) {
        el = document.createElement("div");
        el.id = id;
        el.style.cssText = "margin:8px 0;padding:8px 10px;border:1px dashed #f59e0b;background:#fffaf0;color:#92400e;border-radius:6px;";
        const title = document.getElementById("resultsTitle") || document.body;
        title.parentNode.insertBefore(el, title.nextSibling);
      }
      el.textContent = msg;
    }

    // ==== кэш CSV в localStorage (5 мин) + ретраи + fallback + stale-on-error ====
      const CACHE_TTL_MS = 5 * 60 * 1000;

      // подберите, если нужно ожидать дольше
      function pickTimeoutMs() {
        const et = (navigator.connection && navigator.connection.effectiveType) || "";
        if (et.includes("2g")) return 60000;  // 60 c
        if (et.includes("3g")) return 45000;  // 45 c
        return 20000;                          // 20 c (4g/wi-fi/неизв.)
      }

    async function fetchSheetCSVCached(sheetId, gid) {
      const key = `sheet:${sheetId}:${gid}`;
      const now = Date.now();
      let lastErrs = []; // <-- объявляем заранее

      // читаем кэш (даже если просрочен — будет как запасной вариант)
      let cached = null;
      try { cached = JSON.parse(localStorage.getItem(key) || "null"); } catch { }

      if (cached && (now - cached.ts) < CACHE_TTL_MS && cached.csv) {
        return cached.csv; // свежий кэш — отдаем сразу
      }

      const proxyUrl = `/api/sheet?format=csv&sheetId=${encodeURIComponent(sheetId)}&gid=${encodeURIComponent(gid)}`;
      const directUrl = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/export?format=csv&gid=${encodeURIComponent(gid)}`;

      // fetch с таймаутом
      async function fetchWithTimeout(url, opts = {}, ms) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms ?? pickTimeoutMs());
        try {
          const r = await fetch(url, { ...opts, signal: ctrl.signal });
          return r;
        } catch (e) {
          if (e && e.name === "AbortError") throw new Error("Timeout");
          throw e;
        } finally {
          clearTimeout(t);
        }
      }

      // универсальная попытка с ретраями
      async function tryFetch(url) {
        const delaysMs = [0, 800, 1800]; // 3 попытки
        let last;
        for (let i = 0; i < delaysMs.length; i++) {
          if (delaysMs[i]) await new Promise(r => setTimeout(r, delaysMs[i]));
          try {
            const r = await fetchWithTimeout(url, { cache: i === 0 ? "default" : "reload" });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return await r.text();
          } catch (e) { last = e; }
        }
        throw last || new Error("Failed to fetch");
      }

      // 1) proxy
      try {
        const csv = await tryFetch(proxyUrl);
        try { localStorage.setItem(key, JSON.stringify({ ts: now, csv })); } catch { }
        return csv;
      } catch (e1) {
        lastErrs.push(`proxy: ${e1?.message || e1}`);
      }

      // 2) proxy (reload)
      try {
        const csv = await tryFetch(proxyUrl);
        try { localStorage.setItem(key, JSON.stringify({ ts: now, csv })); } catch { }
        return csv;
      } catch (e2) {
        lastErrs.push(`proxy(reload): ${e2?.message || e2}`);
      }

      // 3) google напрямую
      try {
        const csv = await tryFetch(directUrl);
        try { localStorage.setItem(key, JSON.stringify({ ts: now, csv })); } catch { }
        return csv;
      } catch (e3) {
        lastErrs.push(`google: ${e3?.message || e3}`);
      }

      // 4) есть кэш — показываем его и предупреждение
      if (cached && cached.csv) {
        showStaleNotice("Показаны данные из кэша: сеть нестабильна/медленная.");
        return cached.csv;
      }

      // 5) совсем не удалось
      throw new Error("Не удалось получить CSV: " + lastErrs.join("; "));
    }

    /* ===== Состояние ===== */
    const datasets = {
      lathe: { dataStore: [], headerMap: {}, loaded: false },
      milling: { dataStore: [], headerMap: {}, loaded: false }
    };
    let activeTab = 'lathe';

    /* ===== Утилиты ===== */
    const check = '✓', cross = '—';
    const fmt = v => (v === -1 || v === '' || v == null ? '—' : v);
    function toNumberStrict(v) {
      if (v == null) return null;
      const s = String(v).trim().replace(',', '.');
      if (!/^[+-]?\d+(?:\.\d+)?$/.test(s)) return null;
      return parseFloat(s);
    }
    function num(v) { const n = toNumberStrict(v); return n === null ? -1 : n; }
    function boolStrict(v) {
      if (v == null) return false;
      const n = toNumberStrict(v); if (n !== null) return n > 0;
      const s = String(v).trim().toLowerCase();
      return ['да', 'yes', 'true', 'есть', 'y', '1'].includes(s);
    }
    const safeCell = (m, r, c) => (m[r] && m[r][c] !== undefined) ? m[r][c] : '';
    function showErr(id, msg) { const b = document.getElementById(id); b.textContent = msg; b.style.display = 'block'; }

    function getNumInput(id) {
      const raw = document.getElementById(id).value;
      const s = String(raw).replace(/\s+/g, "").replace(",", ".");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }


    /* CSV-парсер c поддержкой кавычек/запятых */
    function parseCSV(text) {
      const rows = []; let row = [], cur = '', q = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i], n = text[i + 1];
        if (q) {
          if (ch === '"' && n === '"') { cur += '"'; i++; }
          else if (ch === '"') { q = false; }
          else { cur += ch; }
        } else {
          if (ch === '"') q = true;
          else if (ch === ',') { row.push(cur); cur = ''; }
          else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
          else if (ch === '\r') { /* skip */ }
          else { cur += ch; }
        }
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows.filter(r => r.length && !(r.length === 1 && r[0] === ''));
    }

    /* ===== Автодетект строк для токарных ===== */
    function rowText(m, r) {
      const c0 = String(m[r]?.[0] ?? '').trim().toLowerCase();
      const c1 = String(m[r]?.[1] ?? '').trim().toLowerCase();
      return c0 || c1;
    }
    function findRowIndexAdvanced(m, inc, exc = null, maxScan = 160) {
      for (let r = 0; r < Math.min(maxScan, m.length); r++) {
        const t = rowText(m, r);
        if (!t) continue;
        if (inc.test(t) && (!exc || !exc.test(t))) return r;
      }
      return -1;
    }
    function rowScore(m, r, checkBool = false, maxCols = 20) {
      if (r < 0 || r >= m.length) return -1;
      const cols = Math.min(m[0]?.length || 0, 3 + maxCols); let s = 0;
      for (let j = 3; j < cols; j++) {
        const v = m[r]?.[j];
        if (checkBool) {
          const n = toNumberStrict(v);
          if (n !== null && n > 0) { s++; continue; }
          const ss = String(v || '').trim().toLowerCase();
          if (/(^|\b)(да|yes|true|есть|y|1)\b/.test(ss)) s++;
        } else {
          if (toNumberStrict(v) !== null) s++;
        }
      }
      return s;
    }
    function adjustRowIfNeeded(m, r, checkBool = false) {
      if (r < 0) return r;
      const s0 = rowScore(m, r, checkBool), s1 = rowScore(m, r + 1, checkBool);
      return (s1 > s0) ? r + 1 : r;
    }
    function detectRowPositionsLathe(m) {
      let r_v9 = findRowIndexAdvanced(m, /максимал.*диаметр.*точен/i);
      let r_v10 = findRowIndexAdvanced(m, /максимал.*длина.*(точен|заготовк)/i);
      let r_v34 = findRowIndexAdvanced(m, /(максимал.*)?(числ|скорост).*оборот.*шпиндел/i);
      let r_v35 = findRowIndexAdvanced(m, /(диаметр|размер).*патрон/i);
      let r_f15 = findRowIndexAdvanced(m, /\bось\s*y\b/i);
      let r_f17 = findRowIndexAdvanced(m, /противо?шпиндел|ось\s*z2/i);
      let r_tool = findRowIndexAdvanced(m, /скорост.*вращен.*инструмент/i);

      r_v9 = adjustRowIfNeeded(m, r_v9, false);
      r_v10 = adjustRowIfNeeded(m, r_v10, false);
      r_v34 = adjustRowIfNeeded(m, r_v34, false);
      r_v35 = adjustRowIfNeeded(m, r_v35, false);
      r_f15 = adjustRowIfNeeded(m, r_f15, true);
      r_f17 = adjustRowIfNeeded(m, r_f17, true);
      r_tool = adjustRowIfNeeded(m, r_tool, false);

      return {
        v9: r_v9 !== -1 ? r_v9 : 8,
        v10: r_v10 !== -1 ? r_v10 : 9,
        v34: r_v34 !== -1 ? r_v34 : 33,
        v35: r_v35 !== -1 ? r_v35 : 35,
        f15: r_f15 !== -1 ? r_f15 : 14,
        f17: r_f17 !== -1 ? r_f17 : 16,
        toolSpeedRow: r_tool !== -1 ? r_tool : 55
      };
    }

    /* ===== Преобразование данных ===== */
    function matrixToRecordsLathe(m) {
      const res = [], map = {}; if (!m.length) return { res, map };
      const R = detectRowPositionsLathe(m);
      const cols = m[0].length;
      for (let j = 3; j < cols; j++) {
        // id и name берём из строки 3 таблицы (index 2) — это модель
        const typeRaw = String(safeCell(m, 0, j)).trim(); // тип станка (строка 1)
        const modelRaw = String(safeCell(m, 2, j)).trim(); // модель (строка 3)
        if (!modelRaw) continue;

        const id = modelRaw.toLowerCase();
        const name = modelRaw;
        const brand = String(safeCell(m, 1, j)).trim();

        const item = {
          id,
          header: modelRaw,
          name,
          brand,
          v9: num(safeCell(m, R.v9, j)),
          v10: num(safeCell(m, R.v10, j)),
          v34: num(safeCell(m, R.v34, j)),
          v35: num(safeCell(m, R.v35, j)),
          f15: boolStrict(safeCell(m, R.f15, j)),
          f17: boolStrict(safeCell(m, R.f17, j)),
          f56: (num(safeCell(m, R.toolSpeedRow, j)) > 0)
        };
        res.push(item);
        (map[typeRaw] = map[typeRaw] || []).push(item);
      }
      return { res, map };
    }

    function matrixToRecordsMilling(m) {
      const res = [], map = {}; if (!m.length) return { res, map };
      // Карта строк (0-based индексы):
      const R = {
        type: 0,
        len: 7,
        width: 8,
        spindleSpeed: 42,
        powerConst: 43,
        powerMax: 44,
        axisX: 17,
        axisY: 18,
        axisZ: 19,
        taper: 46,
        axisW: 20
      };
      const cols = m[0].length;
      for (let j = 3; j < cols; j++) {
        const modelRaw = String(safeCell(m, 2, j)).trim(); // модель = строка 3
        const id = modelRaw.toLowerCase();
        if (!id) continue;

        const name = modelRaw;
        const brand = String(safeCell(m, 1, j)).trim();

        const item = {
          id,
          header: modelRaw,
          name,
          brand,
          type: String(safeCell(m, R.type, j)).trim(),
          len: num(safeCell(m, R.len, j)),
          width: num(safeCell(m, R.width, j)),
          spindleSpeed: num(safeCell(m, R.spindleSpeed, j)),
          powerConst: num(safeCell(m, R.powerConst, j)),
          powerMax: num(safeCell(m, R.powerMax, j)),
          axisX: num(safeCell(m, R.axisX, j)),
          axisY: num(safeCell(m, R.axisY, j)),
          axisZ: num(safeCell(m, R.axisZ, j)),
          taper: String(safeCell(m, R.taper, j)).trim(),
          axisW: num(safeCell(m, R.axisW, j))
        };
        res.push(item);
        (map[id] = map[id] || []).push(item);
      }
      return { res, map };
    }

    /* ===== Селекты ===== */
    function fillSelectLathe(headerMap) {
      const sel = document.getElementById('L-C3');
      sel.innerHTML = '<option value="">— Все типы —</option>';
      Object.keys(headerMap).sort().forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key.charAt(0).toUpperCase() + key.slice(1);
        sel.appendChild(opt);
      });
    }
    function fillSelectMilling(dataStore) {
      const tSel = document.getElementById('M-C3');
      const taperSel = document.getElementById('M-C12');
      const types = new Set(), tapers = new Set();
      dataStore.forEach(it => {
        if (it.type) types.add(it.type);
        if (it.taper) tapers.add(it.taper);
      });
      tSel.innerHTML = '<option value="">— Все типы станков —</option>' +
        [...types].sort().map(v => `<option value="${v}">${v}</option>`).join('');
      taperSel.innerHTML = '<option value="">— Любой конус шпинделя —</option>' +
        [...tapers].sort().map(v => `<option value="${v}">${v}</option>`).join('');
    }

    /* ===== Рендер таблиц ===== */
    function esc(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }
    function renderTableLathe(items) {
      if (!items || !items.length) return '<div class="empty">Ничего не найдено</div>';
      const rows = items.map(it => `
      <tr class="res-row" data-id="${it.id}">
        <td><strong>${it.brand ? esc(it.brand) : "<span class='muted'>—</span>"}</strong></td>
        <td class="td-name">${it.name ? esc(it.name) : "<span class='muted'>—</span>"}</td>
        <td>${fmt(it.v9)}</td>
        <td>${fmt(it.v10)}</td>
        <td>${fmt(it.v34)}</td>
        <td>${fmt(it.v35)}</td>
        <td class="td-flag">${it.f15 ? check : cross}</td>
        <td class="td-flag">${it.f17 ? check : cross}</td>
        <td class="td-flag">${it.f56 ? check : cross}</td>
      </tr>
    `).join('');
      return `
      <table>
        <thead>
          <tr>
            <th>Производитель</th>
            <th>Модель</th>
            <th title="Макс. диаметр точения">Ø Точения</th>
            <th title="Макс. длина точения">Длина</th>
            <th title="Макс. скорость шпинделя">Скорость шпинделя</th>
            <th title="Диаметр патрона">Патрон</th>
            <th class="td-flag">Ось Y</th>
            <th class="td-flag">Противошп.</th>
            <th class="td-flag">Привод.инстр.</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    }
    function renderTableMilling(items) {
      if (!items || !items.length) return '<div class="empty">Ничего не найдено</div>';
      const rows = items.map(it => `
      <tr class="res-row" data-id="${it.id}">
        <td><strong>${it.brand ? esc(it.brand) : "<span class='muted'>—</span>"}</strong></td>
        <td class="td-name">${it.name ? esc(it.name) : "<span class='muted'>—</span>"}</td>
        <td>${fmt(it.type)}</td>
        <td>${fmt(it.len)}</td>
        <td>${fmt(it.width)}</td>
        <td>${fmt(it.spindleSpeed)}</td>
        <td>${fmt(it.powerConst)}</td>
        <td>${fmt(it.powerMax)}</td>
        <td>${fmt(it.axisX)}</td>
        <td>${fmt(it.axisY)}</td>
        <td>${fmt(it.axisZ)}</td>
        <td>${fmt(it.taper)}</td>
        <td>${fmt(it.axisW)}</td>
      </tr>
    `).join('');
      return `
      <table>
        <thead>
          <tr>
            <th>Производитель</th>
            <th>Модель</th>
            <th>Тип</th>
            <th>Длина стола</th>
            <th>Ширина стола</th>
            <th>Скорость шпинделя</th>
            <th>Мощн. пост.</th>
            <th>Мощн. макс.</th>
            <th>Ход X</th>
            <th>Ход Y</th>
            <th>Ход Z</th>
            <th>Конус</th>
            <th>Ось W</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    /* ===== Загрузка по вкладкам (+кэш) ===== */
    async function loadTabData(tabKey) {
      const tab = TABS[tabKey];
      const state = datasets[tabKey];
      const loading = document.getElementById("loading");
      loading.style.display = "block";

      try {
        if (!state.loaded) {
          // получаем CSV (из localStorage или сети), парсим
          const csv = await fetchSheetCSVCached(SPREADSHEET_ID, tab.gid);
          const matrix = parseCSV(csv);

          const parsed = (tabKey === "lathe")
            ? matrixToRecordsLathe(matrix)
            : matrixToRecordsMilling(matrix);

          state.dataStore = parsed.res;
          state.headerMap = parsed.map;
          state.loaded = true;
        }

        // заполнение селектов
        if (tabKey === "lathe") {
          fillSelectLathe(state.headerMap);
        } else {
          fillSelectMilling(state.dataStore);
        }

        // очищаем правую колонку до поиска
        document.getElementById("results").innerHTML = "";
      } catch (e) {
        const errId = (tabKey === "lathe") ? "error" : "error-m";
        showErr(
          errId,
          "Не удалось загрузить данные (CSV).\nПроверьте доступ к листу и gid.\n\n" +
          (e && e.message ? e.message : String(e))
        );
      } finally {
        loading.style.display = "none";
      }
    }

    /* ===== Поиск ===== */
    function doSearchLathe() {
      const { dataStore, headerMap } = datasets.lathe;
      if (!dataStore.length) { alert('Данные ещё загружаются…'); return; }

      const C3 = document.getElementById('L-C3').value;
      const C4 = getNumInput('L-C4');  // Ø точения
      const C5 = getNumInput('L-C5');  // длина
      const C6 = getNumInput('L-C6');  // скорость шпинделя
      const C7 = getNumInput('L-C7');  // патрон
      const C8 = document.getElementById('L-C8').checked;
      const C9 = document.getElementById('L-C9').checked;
      const C10 = document.getElementById('L-C10').checked;

      const cand = (C3 && headerMap[C3]) ? headerMap[C3] : dataStore;
      const matches = [];
      for (const item of cand) {
        if (!item.name) continue;
        if (C4 && (item.v9 === -1 || C4 > item.v9 || (C4 + 100) < item.v9)) continue;
        if (C5 && (item.v10 === -1 || C5 > item.v10 || (C5 + C5 * 1.5) < item.v10)) continue;
        if (C6 && (item.v34 === -1 || item.v34 < C6)) continue;
        if (C7 && (item.v35 === -1 || item.v35 < C7)) continue; // патрон ≥ требуемого
        if (C8 && !item.f15) continue;
        if (C9 && !item.f17) continue;
        if (C10 && !item.f56) continue;
        matches.push(item);
      }
      document.getElementById('results').innerHTML = renderTableLathe(matches);
    }

    function doSearchMilling() {
      const { dataStore } = datasets.milling;
      if (!dataStore.length) { alert('Данные ещё загружаются…'); return; }

      const F = {
        type: document.getElementById('M-C3').value.trim(),
        len: getNumInput('M-C4'),
        width: getNumInput('M-C5'),
        spin: getNumInput('M-C6'),
        pConst: getNumInput('M-C7'),
        pMax: getNumInput('M-C8'),
        x: getNumInput('M-C9'),
        y: getNumInput('M-C10'),
        z: getNumInput('M-C11'),
        taper: document.getElementById('M-C12').value.trim(),
        w: document.getElementById('M-C13').checked
      };

      const matches = [];
      for (const it of dataStore) {
        if (!it.name) continue;
        if (F.type && String(it.type).trim() !== F.type) continue;
        if (F.taper && String(it.taper).trim() !== F.taper) continue;
        if (F.len && (it.len === -1 || it.len < F.len)) continue;
        if (F.width && (it.width === -1 || it.width < F.width)) continue;
        if (F.spin && (it.spindleSpeed === -1 || it.spindleSpeed < F.spin)) continue;
        if (F.pConst && (it.powerConst === -1 || it.powerConst < F.pConst)) continue;
        if (F.pMax && (it.powerMax === -1 || it.powerMax < F.pMax)) continue;
        if (F.x && (it.axisX === -1 || it.axisX < F.x)) continue;
        if (F.y && (it.axisY === -1 || it.axisY < F.y)) continue;
        if (F.z && (it.axisZ === -1 || it.axisZ < F.z)) continue;
        if (F.w && !(it.axisW > 0)) continue; // ось W должна существовать
        matches.push(it);
      }
      document.getElementById('results').innerHTML = renderTableMilling(matches);
    }

    /* ===== Клики по строкам (делегирование) ===== */
    function openDetails(rawId) {
      const id = encodeURIComponent(rawId);
      const tabParam = `&tab=${encodeURIComponent(activeTab)}`;
      window.open(`details.html?id=${id}${tabParam}`, '_blank');
    }
    function setupRowClickDelegation() {
      document.getElementById('results').addEventListener('click', (e) => {
        const tr = e.target.closest('tr.res-row');
        if (!tr) return;
        const id = tr.dataset.id;
        if (id) openDetails(id);
      });
    }

    /* ===== Инициализация ===== */
    window.addEventListener('DOMContentLoaded', async () => {
      setupRowClickDelegation();

      // вкладки
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (btn.dataset.tab === activeTab) return;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeTab = btn.dataset.tab;
          document.getElementById('form-lathe').classList.toggle('hidden', activeTab !== 'lathe');
          document.getElementById('form-milling').classList.toggle('hidden', activeTab !== 'milling');
          await loadTabData(activeTab);
        });
      });

      document.getElementById('btn-search-lathe').addEventListener('click', doSearchLathe);
      document.getElementById('btn-search-milling').addEventListener('click', doSearchMilling);

      // стартуем с токарных
      await loadTabData(activeTab);
    });
  </script>
</body>

</html>